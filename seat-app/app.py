import streamlit as st
import pandas as pd
from PIL import Image, ImageDraw
import os

# --------------------------------------------------
# ãƒšãƒ¼ã‚¸ã®è¨­å®š
# --------------------------------------------------
st.set_page_config(page_title="åº§å¸­æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ", layout="centered")
st.title("ğŸ“ è¬›ç¾©åº§å¸­æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ")

# --------------------------------------------------
# 1. ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
# --------------------------------------------------
if not os.path.exists("data.csv"):
    st.error("ã€data.csvã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚")
    st.stop()

if not os.path.exists("classroom_map.png"):
    st.error("ã€classroom_map.pngã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åº§å¸­è¡¨ã®ç”»åƒã‚’åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚")
    st.stop()

# --------------------------------------------------
# 2. ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
# --------------------------------------------------
try:
    df = pd.read_csv("data.csv", encoding='utf-8') # æ–‡å­—åŒ–ã‘ã™ã‚‹ãªã‚‰ encoding='shift_jis' ã«å¤‰ãˆã‚‹
    # å­¦ç”Ÿç•ªå·ã‚’æ–‡å­—ã¨ã—ã¦æ‰±ã†
    df["student_id"] = df["student_id"].astype(str)
except Exception as e:
    st.error(f"CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
    st.stop()

# --------------------------------------------------
# 3. æ¤œç´¢ç”»é¢ã‚’ä½œã‚‹
# --------------------------------------------------
st.markdown("##### å­¦ç”Ÿç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
search_id = st.text_input("", placeholder="ä¾‹ï¼š2024001")
search_btn = st.button("æ¤œç´¢ã™ã‚‹")

# --------------------------------------------------
# 4. æ¤œç´¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
# --------------------------------------------------
if search_btn and search_id:
    # ãƒ‡ãƒ¼ã‚¿ã®ä¸­ã‹ã‚‰ã€å…¥åŠ›ã•ã‚ŒãŸç•ªå·ã¨ä¸€è‡´ã™ã‚‹è¡Œã‚’æ¢ã™
    result = df[df["student_id"] == search_id]

    if not result.empty:
        # --- è¦‹ã¤ã‹ã£ãŸå ´åˆ ---
        row = result.iloc[0]     # ãã®äººã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        seat_no = row["seat_no"] # åº§å¸­ç•ªå·
        st.success(f"ã‚ãªãŸã®åº§å¸­ã¯ **{seat_no}** ã§ã™ï¼")

        # --- åœ°å›³ã«èµ¤ä¸¸ã‚’ã¤ã‘ã‚‹å‡¦ç† ---
        try:
            # ç”»åƒã‚’èª­ã¿è¾¼ã‚€
            img = Image.open("classroom_map.png")
            draw = ImageDraw.Draw(img)

            # CSVã‹ã‚‰åº§æ¨™(x, y)ã‚’å–å¾—
            x = int(row["x"])
            y = int(row["y"])
            
            # èµ¤ä¸¸ã®ã‚µã‚¤ã‚ºï¼ˆåŠå¾„ï¼‰
            r = 30 
            
            # èµ¤ä¸¸ã‚’æã (x, y ã‚’ä¸­å¿ƒã«å††ã‚’æã)
            draw.ellipse((x - r, y - r, x + r, y + r), fill=(255, 0, 0), outline="white", width=3)
            
            # ç”»é¢ã«ç”»åƒã‚’è¡¨ç¤º
            st.image(img, caption="èµ¤ä¸¸ã®å ´æ‰€ãŒã‚ãªãŸã®å¸­ã§ã™", use_column_width=True)
            
        except Exception as e:
            st.error(f"ç”»åƒã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸ: {e}")
            st.write("CSVã® x, y åˆ—ã«æ­£ã—ã„æ•°å­—ãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
            
    else:
        # --- è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ ---
        st.warning("è©²å½“ã™ã‚‹å­¦ç”Ÿç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç•ªå·ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")

